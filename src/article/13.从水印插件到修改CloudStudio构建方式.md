# èƒŒæ™¯

äº‹æƒ…çš„èµ·å› æ˜¯è¿™æ ·ï¼Œç”±äºç‰¹æ®Šéœ€æ±‚éœ€è¦åœ¨æˆ‘ä»¬ webide ä¸Šå¢åŠ æ°´å°èƒŒæ™¯å›¾æ•ˆæœï¼Œç”¨äº`éœ‡æ…‘`ä½œç”¨ï¼Œï¼ˆğŸ˜Šï¼‰ï¼Œèµ·åˆæ˜¯æ‰“ç®—ç”¨æ’ä»¶çš„å½¢å¼æ¥å®ç°ï¼ŒåŸç†æ˜¯ç›´æ¥ä¿®æ”¹ vscode å¯¹åº” css æ–‡ä»¶é‡Œçš„æ ·å¼ï¼Œå¢åŠ èƒŒæ™¯å›¾å±æ€§ï¼Œä½†æœ€æ–°ç‰ˆæœ¬çš„ vscode ä¼¼ä¹åœ¨åå°è¿›è¡Œäº†æ–‡ä»¶æ›´æ”¹æ£€æŸ¥ï¼Œå¯¼è‡´ç›´æ¥ä¿®æ”¹ css æ–‡ä»¶æ— æ•ˆï¼ŒğŸ‘‡

> ![1.png](../assets/img/13/1.png)

å¯èƒ½æ˜¯å®³æ€•ç”¨æˆ·æŠŠæ–‡ä»¶æ”¹åäº†å¯¼è‡´èµ·ä¸æ¥äº†å§ã€‚ã€‚
ä½†åŠæ³•è¿˜æ˜¯æœ‰çš„ï¼Œvscode çš„æ–‡ä»¶åŠ è½½é¡ºåºæµç¨‹æ˜¯å…ˆä»ä½  `/{æºç›®å½•}/Content/Resources/app/out/vs/code/electron-browser/workbench/workbench.html` å¼€å§‹åŠ è½½çš„ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ª js æ–‡ä»¶ï¼Œå°±æ˜¯è´Ÿè´£ç”¨äº load å…¶ä»–æ–‡ä»¶åŠ è½½ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ç›´æ¥åœ¨è¿™ä¸ª html æ–‡ä»¶ä¸‹ç›´æ¥æ·»åŠ  style æ ‡ç­¾å¼ºåˆ¶ä¿®æ”¹æ ·å¼æ˜¯å¦å¯è¡Œå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ˜¯åœ¨ vscode æ‰§è¡Œæ–‡ä»¶æ›´æ”¹æ£€æµ‹ä¹‹å‰å°±æŠŠ html æ–‡ä»¶æ”¹äº†

# æ°´å°æ’ä»¶

æœ‰äº†æ€è·¯ä¹‹åå‰©ä¸‹çš„å°±äº¤ç»™ code

åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ `workbench.html` æ–‡ä»¶ä¸‹å¢åŠ  style æ ‡ç­¾ä»£ç 
``` CSS
.monaco-editor::before,
.monaco-editor-background::before,
.monaco-editor .inputarea.ime-input::before {
    content: " ";
    background-image: url(${base64ä»£ç }) !important;
    width: 100%;
    height: 1000vh;
    position: absolute;
    background-position: center;
    transform-origin: 0;
    transform: rotate(-20deg);
    opacity: 0.04;
    z-index: 1;
    pointer-events: none;
}
```

è¿™é‡ŒèƒŒæ™¯å›¾é‡‡ç”¨ base64 æ˜¯ä¸ºäº†ä¿è¯å›¾ç‰‡ä¸è½åœ°ï¼Œæ¯æ¬¡æ‰“å¼€éƒ½æ˜¯éœ€è¦é‡æ–°ç”Ÿæˆçš„;

ç„¶åæ ¹æ®åå­—ç”Ÿæˆæ°´å°å›¾ç‰‡æ˜¯ç”¨äº† [`text-to-svg`](https://github.com/shrhdk/text-to-svg) è¿™ä¸ªåº“

ç”Ÿæˆä»£ç å¦‚ä¸‹

```Typescript
// @ts-ignore
import * as TextToSVG from 'text-to-svg';

const textToSVG = TextToSVG.loadSync();

import * as fs from 'fs';
import * as path from 'path';
import { logger } from './logger';

const dirName = __dirname;

const toBase64 = (file: fs.PathLike) => {
	var bitmap = fs.readFileSync(file);
	return new Buffer(bitmap).toString('base64');
};

export const generateWaterMark = (text: string): Promise<string> => {
	text = text.split(' ').join('');
	const pngName = `watermark.svg`;

	const pngPath = path.join(dirName, `./${pngName}`);

	logger.appendLine(`pngPath: ${pngPath}`);

	return new Promise((res, rej) => {
		const options = { x: 0, y: 0, fontSize: 32, anchor: 'top', attributes: { fill: '#ccc' } };

		const svgPath = textToSVG.getPath(text, options);
		const metrics = textToSVG.getMetrics(text, options);

		const width = metrics.width || 0;

		const svgTemp = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${width +
			100}" height="128">${svgPath}</svg>`;

		fs.writeFile(pngPath, svgTemp, {}, (err: Error) => {
			if (err) {
				logger.appendLine(err.toString());
				return;
			}
			res(toBase64(pngPath));
			if (fs.existsSync(pngPath)) {
				fs.unlinkSync(pngPath);
			}
		});
	});
};
```

é€šè¿‡å®éªŒåœ¨æœ¬åœ°æœºå™¨ä¸Šç¡®å®æ˜¯å¯è¡Œçš„ï¼Œç¾æ»‹æ»‹ï¼Œç„¶åæˆ‘ä»¬å˜æŠŠå®ƒæ‰“åŒ…å‡ºæ¥æ”¾åœ¨ CS ä¸Šè¯•è¯•ï¼Œç»“æœå´è¢«æç¤º `workbench.htlm` æ–‡ä»¶è·¯å¾„æ‰¾ä¸åˆ°ï¼

æ£€æŸ¥ä¸€çœ‹ `vscode.env.appRoot` æ–¹æ³•è¿”å›çš„ç¡®å®æ˜¯ä¸€æ®µä¸å­˜åœ¨çš„è·¯å¾„ï¼›

æˆ‘ä»¬é€šè¿‡è¿›ç¨‹å‘ç°åŸæ¥åœ¨å®¹å™¨é‡Œè¿è¡Œçš„ webide ä¸»è¿›ç¨‹æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé‡Œé¢æ„é€ çš„è™šæ‹Ÿç›®å½•å½“ç„¶æ˜¯è®¿é—®ä¸äº†å¤–é¢çš„çœŸå®ç›®å½•çš„ã€‚ã€‚ã€‚

è¿™ä¸ªé—®é¢˜è²Œä¼¼ä¹Ÿä¼šå‘ç°åœ¨å…¶ä»–æ’ä»¶é‡Œï¼Œè­¬å¦‚æœ€åŸºæœ¬çš„ git æ’ä»¶ï¼Œå®ƒæ˜¯éœ€è¦è®¿é—®åˆ°é¡¹ç›®ä»£ç é‡Œçš„çœŸå®ç›®å½•çš„ï¼Œä½†å¦‚æœæ˜¯é‡‡ç”¨äºŒè¿›åˆ¶æ–‡ä»¶è¿è¡Œåˆ™ä¼šæŠ¥é”™ï¼Œä¸ºæ­¤ç»è¿‡å•†æ¦·æˆ‘ä»¬ä¸å¦‚å°†å…¶æ”¹ä¸º node è¿›ç¨‹å¯åŠ¨ webide ä¸»è¿›ç¨‹

# æ”¹é€  binary æ–¹å¼

å®ç°æ€è·¯å¾ˆç®€å•, æœ‰å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤

> å…ˆ clone å¯¹åº”ç‰ˆæœ¬çš„ vscode é¡¹ç›® â€”â€”> æ‰“è¡¥ä¸ patch é­”æ”¹éƒ¨åˆ† â€”â€”> æ‰§è¡Œ build ç¼–è¯‘ â€”â€”> ç¼–è¯‘å†…ç½®æ’ä»¶ â€”â€”> æå–ç¼–è¯‘åçš„ out ç›®å½•å’Œéœ€è¦çš„ä¸¤ä¸ª json æ–‡ä»¶ä¸å†…ç½®æ’ä»¶ç›®å½• â€”â€”> ä»è…¾è®¯äº‘ COS æŠŠå¯¹åº”ç‰ˆæœ¬çš„ node æ¨¡å—å¤åˆ¶è¿›æ¥ â€”â€”> å¤åˆ¶ cloudstudio.js å¯åŠ¨è„šæœ¬æ–‡ä»¶è¿›æ¥ â€”â€”> åˆ›å»º dist ç›®å½•ï¼ŒæŠŠä¸Šè¿°æ–‡ä»¶å¤åˆ¶è¿›æ¥ â€”â€”> æ‰“æˆ Tar æ ¼å¼åŒ…æ–‡ä»¶å¤åˆ¶åˆ°å¯åŠ¨ç›®å½•

æ”¹é€ çš„ binary æ–¹æ³•å¦‚ä¸‹

```Typescript
private async binary(vscodeSourcePath: string, binariesPath: string, finalBuildPath: string): Promise<void> {
    const nodeTarName = 'node-v10.15.1-linux-x64-no-outside-dir.tar.gz';
    const nodeName = "cloudstudio-node";
    const cosUrl = `...`; // å›ºå®šç‰ˆæœ¬ node æ¨¡å—ä¸‹è½½åœ°å€
    const tmpPath = os.tmpdir();
    const csJs = "cloudstudio.js";
    const distPath = path.join(finalBuildPath, "dist");
    this.log("[vscodeSourcePath]: " + vscodeSourcePath);
    this.log("[binariesPath]: " + binariesPath);
    this.log("[finalBuildPath]: " + finalBuildPath);
    await this.task("Dowload node V10.15.1 for COS", async () => {
        await util.promisify(cp.exec)(`curl ${cosUrl} -o ${nodeTarName}`, { cwd: tmpPath })
    })

    await this.task(`Extar ${nodeTarName}`, async () => {
        if (!fs.existsSync(path.join(finalBuildPath, nodeName))) fs.mkdirSync(path.join(finalBuildPath, nodeName));
        await util.promisify(cp.exec)(`tar zxvf ${path.join(tmpPath, nodeTarName)} -C ${nodeName}/ >/dev/null 2>&1`, { cwd: finalBuildPath });
    })

    await this.task(`Copy cloudstudio.js`, async () => {
        await util.promisify(cp.exec)(`cp ${path.join(__dirname, "cloudstudio.js")} ${finalBuildPath}`)
    })

    await this.task(`Create Dist`, async () => {
        const distLs = [nodeName, 'node_modules', 'package.json', 'product.json', 'out', 'extensions', csJs];

        fs.removeSync(distPath);
        fs.mkdirSync(distPath);

        for(const e of distLs) {
            await util.promisify(cp.exec)(`cp -rf ${e} dist/`, { cwd: finalBuildPath });
            if (e === "out") {
                await fs.copy(path.join(finalBuildPath, "out/vs/server/src/browser/workbench-build.html"), path.join(finalBuildPath, "out/vs/server/src/browser/workbench.html"));
            }
        };
    })

    await this.task(`Tar Dist`, async () => {
        await util.promisify(cp.exec)(`tar zcvf dist.tar.gz dist >/dev/null 2>&1`, { cwd: finalBuildPath });
        await util.promisify(cp.exec)(`cp dist.tar.gz ${binariesPath}`, { cwd: finalBuildPath })
    })
}
```

ä¿®æ”¹ä¸‹ ci.bash ä»¤å…¶æ‰§è¡Œå®Œ docker-exec build ä¹‹åæ‰§è¡Œ docker-exec binary å³å¯ 

æœ€ç»ˆç”Ÿæˆçš„ç›®å½•å¦‚ä¸‹

> ![2.png](../assets/img/13/2.png)

å…¶ä¸­ `cloudstudio-node` ç›®å½•å°±æ˜¯ä¸‹è½½å›ºå®šç‰ˆæœ¬çš„ node æ¨¡å—ï¼Œå¯åŠ¨çš„æ—¶å€™ä¸ºäº†é˜²æ­¢ç”¨æˆ·çš„äº‘ä¸»æœºå¯èƒ½æ²¡æœ‰å®‰è£… node æˆ–æ²¡æœ‰å¯¹åº”çš„å›ºå®šç‰ˆæœ¬ node åˆ™é‡‡ç”¨è¯¥æ–¹å¼ã€‚`cloudstudio.js` çš„æ‰§è¡Œåˆ™æ›´ç®€å•ï¼Œåªéœ€å¯åŠ¨ `out` ç›®å½•é‡Œçš„ out/vs/server/main.js æ–‡ä»¶å³å¯

``` Typescript
const cp = require("child_process");
const spawn = cp.spawn;
const process = require("process");

const dirName = __dirname;

const run = () => {
	const argv = process.argv.slice(2);
	const runNode = spawn(`${dirName}/cloudstudio-node/bin/node`, [`${dirName}/out/vs/server/main.js`, ...argv]);
	runNode.stdout.on("data", (data) => {
		console.log(data.toString())
	})
	runNode.stdout.on("error", (err) => {
		console.error(err)
	})
}

run()
```

ç„¶åæˆ‘ä»¬ä¿®æ”¹ `supervisord.conf` å¯åŠ¨é…ç½®å³å¯ `/app/cloudstudio-node/bin/node /app/cloudstudio.js --auth none --host=0.0.0.0 --port=65210`

æˆ‘ä»¬é€šè¿‡å‘½ä»¤æŸ¥çœ‹åˆ°ç¡®å®æ˜¯é€šè¿‡ node å¯åŠ¨çš„

> ![3.png](../assets/img/13/3.png)

è¿™ä¸‹ä¸ä»…è§£å†³æ°´å°é—®é¢˜ï¼Œè¿æ–‡ä»¶ç›®å½•è¯»å–ä¹Ÿè§£å†³ï¼Œä¸€åˆ‡çœ‹èµ·æ¥è¿˜æ˜¯é‚£ä¹ˆç¾å¥½
