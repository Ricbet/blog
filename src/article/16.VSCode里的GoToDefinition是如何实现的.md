åœ¨ç¼–è¾‘å™¨é¢†åŸŸé‡Œ, â€œè·³è½¬åˆ°å®šä¹‰â€ è¿™ä¸ªåŠŸèƒ½æ˜¯å¾ˆå¤šè¯­è¨€æœåŠ¡é‡Œæœ€å¸¸ç”¨çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆåœ¨ VSCode çš„ä¸–ç•Œé‡Œå®ƒæ˜¯å¦‚ä½•åŒæ—¶å®ç°å¹¶é€‚é…åˆ°å¾ˆå¤šä¸åŒè¯­è¨€é‡Œå»çš„å‘¢ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ VSCode çš„å®˜æ–¹å®šä¹‰ ğŸ‘‡;

![1.png](../assets/img/16/1.png)

ä¹Ÿå°±æ˜¯è¯´å®ƒæœ¬èº«åªæ˜¯ä¸ªè½»é‡çš„æºä»£ç ç¼–è¾‘å™¨ï¼Œå¹¶æ²¡æœ‰æä¾›è¯­è¨€çš„è‡ªåŠ¨è¯­æ³•æ ¡éªŒã€æ ¼å¼åŒ–ã€æ™ºèƒ½æç¤ºå’Œè¡¥å…¨ç­‰ï¼Œç»Ÿç»Ÿéƒ½æ˜¯ä¾é å…¶å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿæ¥å®Œæˆ;

ç”±äºæœ¬èº«æ˜¯åŸºäº `Typescript` å¼€å‘çš„ï¼Œæ‰€ä»¥å†…ç½®äº†å¯¹ `JavaScript`ï¼Œ`TypeScript` å’Œ `Node.js` çš„æ”¯æŒ;

é‚£ä¹ˆ â€œè·³è½¬åˆ°å®šä¹‰â€ è¿™ä¸ªåŠŸèƒ½åŒæ ·ä¹Ÿæ˜¯ç”±å¯¹åº”çš„è¯­è¨€æœåŠ¡æ’ä»¶æ¥æä¾›æ”¯æŒ;

æœ¬æ–‡ä»¥ `Typescript` ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹å†…ç½®çš„ `Typescript` è¯­è¨€æœåŠ¡æ’ä»¶;

åœ¨è¿™ä¹‹å‰éœ€è¦å…ˆç†ŸçŸ¥ä¸€ä¸‹å…³äº [LSP \(Language Server Protocol\)](https://docs.microsoft.com/en-us/visualstudio/extensibility/language-server-protocol?view=vs-2019) è¯­è¨€æœåŠ¡åè®®, åœ¨æœ¬åšå®¢çš„ [WebIDE æŠ€æœ¯ç›¸å…³èµ„æ–™æ•´ç†](https://github.com/Ricbet/blog/blob/master/src/article/15.WebIDE%E6%8A%80%E6%9C%AF%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99.md) è¿™ç¯‡æ–‡ç« æœ‰æåˆ°;

é€šä¿—çš„è®²å°±æ˜¯è¯­è¨€æœåŠ¡å•ç‹¬è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œï¼Œé€šè¿‡ `JSON RPC` ä½œä¸ºåè®®ä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œä¸ºå…¶æä¾›å¦‚è·³è½¬å®šä¹‰ã€è‡ªåŠ¨è¡¥å…¨ç­‰é€šç”¨è¯­è¨€åŠŸèƒ½ï¼Œä¾‹å¦‚ ts çš„ç±»å‹æ£€æŸ¥ã€ç±»å‹è·³è½¬ã€è‡ªåŠ¨è¡¥å…¨ç­‰éƒ½éœ€è¦æœ‰å¯¹åº”çš„ ts è¯­è¨€æœåŠ¡ç«¯å®ç°å¹¶ä¸ Client ç«¯é€šä¿¡ï¼Œå®˜æ–¹æ–‡æ¡£æœ‰æ›´ä¸ºè¯¦ç»†çš„é˜è¿°;

> vscode ç‰ˆæœ¬ 1.41.1

### å†…ç½® Typescript æ’ä»¶

å†…ç½®æ’ä»¶ç›®å½•ä½äº VSCode é¡¹ç›®æ ¹ç›®å½•çš„ `extensions` ç›®å½•ï¼Œé‡Œé¢å’Œ ts æˆ– js æœ‰å…³çš„æ’ä»¶æœ‰

```bash
...
â”œâ”€â”€ javascript
â”œâ”€â”€ typescript-basics
â””â”€â”€ typescript-language-features
...
```

å…¶ä¸­ `javascript` å’Œ `typescript-basics` é‡Œåªæœ‰ä¸€äº› json æ ¼å¼çš„æè¿°æ–‡ä»¶;

é‚£ä¹ˆé‡ç‚¹çœ‹ `typescript-language-features` æ’ä»¶, ç›®å½• ğŸ‘‡;

```bash
â””â”€â”€ src
    â”œâ”€â”€ commands
    â”œâ”€â”€ features
    |   â”œâ”€â”€ ...
    â”‚   â”œâ”€â”€ definitionProviderBase.ts
    â”‚   â”œâ”€â”€ definitions.ts
    |   â”œâ”€â”€ ...
    â”œâ”€â”€ test
    â”œâ”€â”€ tsServer
    â”œâ”€â”€ typings
    â””â”€â”€ utils
```

å…¶ä¸­æˆ‘ä»¬çœ‹åˆ°äº† `features` ç›®å½•ä¸‹ç›®æµ‹å’Œ definitions æœ‰å…³çš„ä¸¤ä¸ªæ–‡ä»¶äº†;

çœ‹æ¥ â€œè·³è½¬åˆ°å®šä¹‰â€ è¿™ä¸ªåŠŸèƒ½é“å®šå’Œè¿™ä¸ªæ’ä»¶æœ‰å¿…ç„¶çš„è”ç³»;

åœ¨äº†è§£äº† `LSP` ä¹‹åå¯ä»¥å¿«é€Ÿæ‰¾åˆ°è¿™ä¸ªæ’ä»¶çš„ Client å®ç°å’Œ Server å®ç°ï¼›

å…¶ä¸­ Client ç«¯çš„å®ç°æœ‰

```
â”œâ”€â”€ typescriptService.ts            // æ¥å£å®šä¹‰
â”œâ”€â”€ typescriptServiceClient.ts      // Client å…·ä½“å®ç°
â”œâ”€â”€ typeScriptServiceClientHost.ts  // ç®¡ç† Client
```

è¿™ä¸‰ä¸ªæ–‡ä»¶

è€Œ Server ç«¯çš„å®ç°åœ¨ `./src/tsServer/server.ts`;

### å¯åŠ¨æµç¨‹

æ—¢ç„¶æ˜¯æ’ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹å®ƒ `package.json` é‡Œ `activationEvents` å­—æ®µæ£€æŸ¥ä¸€ä¸‹æ¿€æ´»æ¡ä»¶æ˜¯ä»€ä¹ˆ

```json
  "activationEvents": [
    "onLanguage:javascript",
    "onLanguage:javascriptreact",
    "onLanguage:typescript",
    "onLanguage:typescriptreact",
    "onLanguage:jsx-tags",
    "onCommand:typescript.reloadProjects",
    "onCommand:javascript.reloadProjects",
    "onCommand:typescript.selectTypeScriptVersion",
    "onCommand:javascript.goToProjectConfig",
    "onCommand:typescript.goToProjectConfig",
    "onCommand:typescript.openTsServerLog",
    "onCommand:workbench.action.tasks.runTask",
    "onCommand:_typescript.configurePlugin",
    "onLanguage:jsonc"
  ],
```

åªæœ‰åœ¨æ‰“å¼€çš„æ–‡ä»¶æ˜¯ js æˆ– ts ç­‰æ‰ä¼šå¾—ä»¥æ¿€æ´»ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹ `extension.ts` æ–‡ä»¶çš„ `activate` å‡½æ•°

```Typescript
export function activate(
	context: vscode.ExtensionContext
): Api {
	const pluginManager = new PluginManager();
	context.subscriptions.push(pluginManager);

	const commandManager = new CommandManager();
	context.subscriptions.push(commandManager);

	const onCompletionAccepted = new vscode.EventEmitter<vscode.CompletionItem>();
	context.subscriptions.push(onCompletionAccepted);

	const lazyClientHost = createLazyClientHost(context, pluginManager, commandManager, item => {
		onCompletionAccepted.fire(item);
	});

	registerCommands(commandManager, lazyClientHost, pluginManager);
	context.subscriptions.push(vscode.workspace.registerTaskProvider('typescript', new TscTaskProvider(lazyClientHost.map(x => x.serviceClient))));
	context.subscriptions.push(new LanguageConfigurationManager());

	import('./features/tsconfig').then(module => {
		context.subscriptions.push(module.register());
	});

	context.subscriptions.push(lazilyActivateClient(lazyClientHost, pluginManager));

	return getExtensionApi(onCompletionAccepted.event, pluginManager);
}
```

å‰é¢æ˜¯æ³¨å†Œä¸€äº›åŸºæ“çš„å‘½ä»¤ï¼Œé‡ç‚¹åœ¨ `createLazyClientHost` å‡½æ•°ï¼Œå¼€å§‹æ„é€ äº† Client ç«¯ç®¡ç†çš„å®ä¾‹ï¼Œè¯¥å‡½æ•°æ ¸å¿ƒæ˜¯ new äº† `TypeScriptServiceClientHost`

åœ¨ `TypeScriptServiceClientHost` ç±»çš„æ„é€ å‡½æ•°é‡Œæ ¸å¿ƒä¸º

```Typescript
// more ...
this.client = this._register(new TypeScriptServiceClient(
    workspaceState,
    version => this.versionStatus.onDidChangeTypeScriptVersion(version),
    pluginManager,
    logDirectoryProvider,
    allModeIds));
// more ...
for (const description of descriptions) {
    const manager = new LanguageProvider(this.client, description, this.commandManager, this.client.telemetryReporter, this.typingsStatus, this.fileConfigurationManager, onCompletionAccepted);
    this.languages.push(manager);
    this._register(manager);
    this.languagePerId.set(description.id, manager);
}

```

æ³¨å†Œäº† `TypeScriptServiceClient` å®ä¾‹å’Œ `LanguageProvider` è¯­è¨€åŠŸèƒ½

å…¶ä¸­ `LanguageProvider` æ„é€ å‡½æ•°æ ¸å¿ƒä¸º

```Typescript
client.onReady(() => this.registerProviders());
```

å¼€å§‹æ³¨å†Œä¸€äº›åŠŸèƒ½å®ç°ï¼Œæ ¸å¿ƒä¸º

```Typescript
private async registerProviders(): Promise<void> {
    const selector = this.documentSelector;

    const cachedResponse = new CachedResponse();

    await Promise.all([
        // more import ...
        import('./features/definitions').then(provider => this._register(provider.register(selector, this.client))),
        // more import ...
    ]);
}
```

å°±æ˜¯åœ¨è¿™é‡Œå¼€å§‹å¯¼å…¥ `definitions` åŠŸèƒ½, æˆ‘ä»¬æ¥çœ‹çœ‹ `definitions.ts` æ–‡ä»¶

æœ«å°¾ä¸º
```Typescript
// more ...
export function register(
	selector: vscode.DocumentSelector,
	client: ITypeScriptServiceClient,
) {
	return vscode.languages.registerDefinitionProvider(selector,
		new TypeScriptDefinitionProvider(client));
}
```

å®ä¾‹åŒ–äº† `TypeScriptDefinitionProvider` ç±», è¯¥ç±»å®šä¹‰ä¸º

```Typescript
export default class TypeScriptDefinitionProvider extends DefinitionProviderBase implements vscode.DefinitionProvider
```

ç»§æ‰¿äº† `DefinitionProviderBase` å’Œå®ç°äº† `vscode.DefinitionProvider` æ¥å£;

å…¶ä¸­æ ¸å¿ƒéƒ¨åˆ†æ˜¯ `TypeScriptDefinitionProviderBase` åŸºç±»çš„ `getSymbolLocations` æ–¹æ³•, æ ¸å¿ƒè¯­å¥ä¸º

```Typescript
protected async getSymbolLocations(
		definitionType: 'definition' | 'implementation' | 'typeDefinition',
		document: vscode.TextDocument,
		position: vscode.Position,
		token: vscode.CancellationToken
	): Promise<vscode.Location[] | undefined> {
        // more ...
        const response = await this.client.execute(definitionType, args, token);
        // more ...
    }
```

æ‰§è¡Œ Client çš„ execute æ–¹æ³•å¹¶è¿”å›å“åº”æ•°æ®, åœ¨ execute å†…éƒ¨æ˜¯å¯åŠ¨ Server æœåŠ¡ï¼Œè°ƒç”¨äº† service æ–¹æ³•

```Typescript
private service(): ServerState.Running {
    if (this.serverState.type === ServerState.Type.Running) {
        return this.serverState;
    }
    if (this.serverState.type === ServerState.Type.Errored) {
        throw this.serverState.error;
    }
    const newState = this.startService();
    if (newState.type === ServerState.Type.Running) {
        return newState;
    }
    throw new Error('Could not create TS service');
}
```

å…¶ä¸­ `startService` å‡½æ•°æ‰æ˜¯çœŸæ­£è°ƒç”¨ ts è¯­è¨€æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œé‡Œé¢æœ‰ä¸€æ®µä¸º

```Typescript
// more ...
if (!fs.existsSync(currentVersion.tsServerPath)) {
    vscode.window.showWarningMessage(localize('noServerFound', 'The path {0} doesn\'t point to a valid tsserver install. Falling back to bundled TypeScript version.', currentVersion.path));

    this.versionPicker.useBundledVersion();
    currentVersion = this.versionPicker.currentVersion;
}
// more ...
```

è¯»å–å½“å‰ ts ç‰ˆæœ¬çš„ server æ–‡ä»¶è·¯å¾„ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œè€Œ currentVersion çš„ tsServerPath å˜é‡ä¸º

```Typescript
public get tsServerPath(): string {
    return path.join(this.path, 'tsserver.js');
}
```

å’±ä»¬ç¿»å±±è¶Šå²­ã€‚ã€‚ã€‚ç»ˆäºæ‰¾åˆ°äº†æœ€ä¸ºæ ¸å¿ƒçš„ä¸€æ®µï¼Œè¯¥ `tsserver.js` æ–‡ä»¶æ˜¯ `extension` ç›®å½•ä¸‹ `node_modules` ç›®å½•çš„ typescript æ¨¡å—ç¼–è¯‘åçš„ lib åŒ…æ–‡ä»¶ï¼Œä¸ºå…¶æä¾›äº†è¯­æ³•åŠŸèƒ½ï¼Œæˆ‘ä»¬è¦æ‰¾çš„ â€œè·³è½¬åˆ°å®šä¹‰â€ çš„ ts å®ç°å°±æ˜¯åœ¨è¿™é‡Œï¼›

è€Œå®ç°åŸç†å°±æ˜¯åœ¨ [typescript](https://github.com/microsoft/TypeScript) ä»“åº“é‡Œ;

"è·³è½¬åˆ°å®šä¹‰" çš„åŸç†å®ç°å°±æ˜¯åœ¨å…¶ `src/services/goToDefinition.ts` ç›®å½•ä¸‹ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åœ¨å‰å¾€ä»”ç»†ç ”ç©¶ç ”ç©¶ [goToDefinition.ts](https://github.com/microsoft/TypeScript/blob/master/src/services/goToDefinition.ts)

### æ€»ç»“

å› æ­¤ï¼Œå®é™…ä¸Š VSCode å¯¹äº Typescript è¯­è¨€çš„ â€œè·³è½¬åˆ°å®šä¹‰â€ å®ç°æµç¨‹æ­¥éª¤å¯ä»¥åˆ†ä¸º

1. æ£€æŸ¥å½“å‰æ‰“å¼€çš„æ–‡ä»¶æ‰€å¯¹åº”çš„è¯­è¨€ç¯å¢ƒï¼Œè‹¥ä¸º ts æˆ– js ç­‰åˆ™æ³¨å†Œ `typescript-language-features` æ’ä»¶
2. ç”¨æˆ·æ‰§è¡Œ `Go to Definition` æ–¹æ³•
3. æ’ä»¶ Client ç«¯å‘èµ· Service ç«¯è¯·æ±‚
4. æ’ä»¶ Service ç«¯å‘èµ·å¯¹ Typescript æ ¸å¿ƒæ–‡ä»¶ `tsserver` çš„è¯·æ±‚å¹¶æ¥æ”¶åˆ°å“åº”
5. Client ç«¯æ¥æ”¶åˆ° Service ç«¯å“åº”è¿”å›ç»™ features é‡Œçš„ definitions
6. definitions è½¬æ¢æˆ VSCode æ‰€éœ€çš„æ ¼å¼å¹¶å“åº”
7. VSCode æ”¶åˆ°å“åº”è·³è½¬åˆ°å¯¹åº”æ–‡ä»¶çš„å¯¹åº”ä½ç½®

done