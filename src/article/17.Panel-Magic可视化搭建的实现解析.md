## ä»‹ç»

[Panel-Magic](https://github.com/Ricbet/panel-magic) æ˜¯ä¸€ä¸ªåŸºäº AngularX+ å¹¶é¢å‘è®¾è®¡å¸ˆæˆ–è¿è¥äººå‘˜çš„å¯è§†åŒ–æ­å»ºå¹³å°ï¼Œç›®å‰ä»…å¯ç”¨äºå¿«é€Ÿç”Ÿæˆå¾®ä¿¡å°ç¨‹åºåº”ç”¨ï¼Œå…·æœ‰ä¸ Photoshop ç›¸ä¼¼çš„äº¤äº’ä½“éªŒï¼ï¼

> å¥½äº†ï¼Œå¹å®Œä¹‹åæ¥ä¸‹æ¥å¼€å§‹ä»æŠ€æœ¯è§’åº¦å‰–ææˆ‘åœ¨åšè¿™ä¸ªæ­å»ºå¹³å°æ—¶å’Œå®ç°åŸç†

åœ¨æ­¤ä¹‹å‰è¯´æ˜è¯¥å¹³å°çš„å®šä½ï¼Œç›®çš„ä¸æ˜¯ç»™æŠ€æœ¯äººå‘˜ç¼–è¾‘å®Œä¹‹åè¿›è¡ŒäºŒæ¬¡å¼€å‘æˆ–ä»£ç çš„å®šåˆ¶åŒ–ã€‚å…³äºè¿™ä¸ªå®šä½é—®é¢˜æˆ‘ä¸ªäººçš„æƒ³æ³•æ˜¯ï¼Œcode é—®é¢˜ä¸å¯èƒ½å®Œå…¨äº¤æ‰˜ç»™å¯è§†åŒ–ç¼–è¾‘ã€é™¤éæ˜¯ç±»ä¼¼ä¼ ç»Ÿçš„ä¼ä¸šä»‹ç»é¡µç­‰è¿˜æœ‰å¯èƒ½å®Œå…¨ä»£æ›¿ï¼Œä½†è¿˜æ˜¯æ¯”ä¸ä¸Šç›´æ¥ä»£ç ç”Ÿæˆçš„å·¥å…·ï¼Œæ‰€ä»¥ Panel-Magic ä¸€å¼€å§‹çš„å®šä½å°±æ˜¯ç»™è®¾è®¡å¸ˆæˆ–è¿è¥äººå‘˜ä½¿ç”¨ï¼Œç”Ÿæˆçš„äº§ç‰©ä¸å†æ˜¯ codeã€‚

## æŠ€æœ¯æ ˆ

-   æ¡†æ¶é€‰å‹ï¼šAngular8
-   UI ç»„ä»¶åº“ï¼š[ng-zorro-antd](https://github.com/NG-ZORRO/ng-zorro-antd)(å®‡å®™ç¬¬ä¸€ç»„ä»¶åº“)
-   æœ¬åœ°å­˜å‚¨ï¼šIndexedDB
-   å“åº”å¼ç¼–ç¨‹åº“ï¼šRxjs
-   ç¼–å†™è¯­è¨€ï¼šTypescript
-   CSS é¢„å¤„ç†å™¨ï¼šSCSS
-   æœ€ç»ˆäº§ç‰©ï¼šJSON

## å·¥ä½œæµç¨‹

![1.png](../assets/img/17/1.svg)

å…³é”®æ˜¯ä¸­é—´çš„æ•°æ®æ¨¡å‹çš„å»ºæ¨¡è¿‡ç¨‹ä»¥åŠå¯è§†åŒ–ç•Œé¢çš„åˆ›å»ºï¼Œç”Ÿæˆçš„æ–°æ•°æ®å’Œæºæ•°æ®éƒ½æ˜¯çº¦å®šå¥½å›ºå®šæ ¼å¼çš„ JSON æè¿°æ–‡ä»¶ï¼Œå…¶åŒ…å«å›ºå®šçš„ key å­—æ®µå’Œå¯¹åº”çš„ value å€¼ç±»å‹ï¼Œç”Ÿæˆå°ç¨‹åºçš„è¿‡ç¨‹åœ¨ç”Ÿæˆå®Œæ–°æ•°æ®ä¹‹å

ç›®å‰æºæ•°æ®çº¦å®šçš„æ•°æ®æ ¼å¼ä¸º

```JSON
{
    "app_id": "",
    "cata_data": [
        {
            "group": "é»˜è®¤ç»„",
            "pages": [
                {
                    "title": "é¦–é¡µ",
                    "name": "é¦–é¡µ",
                    "router": "page10001",
                    "isEdit": false,
                    "uniqueId": 1556693791081,
                },
            ],
            "isEdit": false,
            "uniqueId": 1556693791066,
        }
    ]
    // more ...
}
```

æ›´ä¸ºå®Œæ•´çš„çº¦å®šæ ¼å¼åœ¨ [MockModel.ts](https://github.com/Ricbet/panel-magic/blob/master/src/app/service/hs-xcx/MockModel.ts)

## ç›®å½•ç»“æ„

```termianle
src
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ appdata                                 // AppData æ ¹æœåŠ¡ï¼Œæ•°æ®æ¨¡å‹ AppDataModel çš„æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ base-class                              // åŸºç±»
â”‚   â”œâ”€â”€ core                                    // HttpClient æœåŠ¡
â”‚   â”œâ”€â”€ panel-extend                            // å¯è§†åŒ–æ­å»ºäº¤äº’éƒ¨åˆ†
â”‚   â”‚   â”œâ”€â”€ model                               // æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ panel-assist-arbor                  // å³ä¾§å¯æ“ä½œåŒºåŸŸå¦‚å¯¹é½ã€å›¾å±‚ã€å‰è¿›åé€€ç­‰æ“ä½œå…¥å£
â”‚   â”‚   â”œâ”€â”€ panel-catalogue                     // é¡µé¢åˆ†ç»„ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-event                         // äº‹ä»¶ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-layer                         // å›¾å±‚åˆ—è¡¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-scaleplate                    // æ ‡å°ºç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-scope-enchantment             // æ ¸å¿ƒæ‹–æ‹½éƒ¨åˆ†ï¼ŒåŒ…æ‹¬è¾…åŠ©çº¿ã€è½®å»“æè¿°ç­‰
â”‚   â”‚   â”œâ”€â”€ panel-senior-vessel-edit            // å®¹å™¨ç»„åˆç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-shell                         // â€œæ‰‹æœºå£³â€åŒºåŸŸç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-soul                          // å·¦ä¾§ç»„ä»¶åº“ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ panel-widget                        // æ¯ä¸ªéƒ¨åˆ†ç»„ä»¶å¦‚æŒ‰é’®ã€æ–‡å­—ç­‰
â”‚   â”‚   â”‚   â”œâ”€â”€ all-widget-container
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auxiliaryline-widget
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ button-widget
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ linkrange-widget
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ picture-widget
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rect-widget
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ text-widget
â”‚   â”‚   â”‚   â”œâ”€â”€ all-widget-unit
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ map-view
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ navigation-bar-view
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rich-text-view
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ slideshow-picture-view
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tab-bar-view
â”‚   â”‚   â”‚   â”œâ”€â”€ all-widget-vessel
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ senior-vessel-widget
â”‚   â”‚   â”‚   â””â”€â”€ model
â”‚   â”‚   â”œâ”€â”€ panel-widget-appearance             // â€œè®¾ç½®â€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ model
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-widget-animation
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-widget-clip-path
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-widget-facade
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-widget-filter
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-widget-picture
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-widget-shadow
â”‚   â”‚   â”‚   â””â”€â”€ panel-widget-text
â”‚   â”‚   â”œâ”€â”€ panel-widget-appearance-site        // æ¯ä¸ªéƒ¨åˆ†ç»„ä»¶çš„ä¸“å±â€œè®¾ç½®â€
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-button-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-combination-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-line-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-linkrange-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-map-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-picture-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-rect-site
â”‚   â”‚   â”‚   â”œâ”€â”€ panel-slideshow-picture-site
â”‚   â”‚   â”‚   â””â”€â”€ panel-text-site
â”‚   â”‚   â””â”€â”€ panel-widget-details                // å¼¹å‡ºæ¥çš„â€œè®¾ç½®â€ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ public                                  // å…¬å…±ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ directive
â”‚   â”‚   â”œâ”€â”€ image-gallery
â”‚   â”‚   â”œâ”€â”€ my-color-picker
â”‚   â”‚   â”œâ”€â”€ ng-thumb-auto
â”‚   â”‚   â”œâ”€â”€ pipe
â”‚   â”‚   â”œâ”€â”€ theme
â”‚   â”‚   â”œâ”€â”€ top-navbar
â”‚   â”‚   â””â”€â”€ util
â”‚   â”œâ”€â”€ service                                 // æœåŠ¡ç«¯ service
â”‚   â”‚   â”œâ”€â”€ hs-files
â”‚   â”‚   â””â”€â”€ hs-xcx
â”‚   â””â”€â”€ share
â”œâ”€â”€ assets                                      // èµ„æºæ–‡ä»¶
```

## å¸ƒå±€æ’ç‰ˆ

ä¸ºäº†å®ç°æ›´å¥½çš„è‡ªç”±å¸ƒå±€æ’ç‰ˆï¼Œåœ¨ä¸è€ƒè™‘ä»£ç ç”Ÿæˆçš„æƒ…å†µä¸‹ï¼Œç»å¯¹å®šä½æ˜¯æˆ‘çš„é¦–é€‰é€‰æ‹©ï¼Œä¹Ÿæ›´èƒ½é€‚é…åƒç´ çº§åˆ«çš„å®šåˆ¶ç¼–è¾‘

é™¤äº†å®šä½æ•°æ®ä»¥å¤–ï¼Œæ¯ä¸ªç»„ä»¶å…¶å®éƒ½å…·æœ‰é€šç”¨çš„æ ·å¼æ•°æ®ï¼Œå¦‚è¾¹æ¡†è®¾ç½®ã€é˜´å½±è®¾ç½®ã€æ–‡æœ¬è®¾ç½®ã€å®šä½è®¾ç½®ç­‰é€šç”¨å…ƒç´ ï¼Œç”šè‡³ä¹Ÿå…·æœ‰é€šç”¨çš„äº‹ä»¶è®¾ç½®ï¼Œç„¶åå¯¹äºç¼–è¾‘æ¥è¯´ï¼Œç»„ä»¶åŒæ—¶ä¹Ÿå…·æœ‰å¦‚é€‰ä¸­æ—¶çš„è½®å»“æ ·å¼æ•°æ®ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŸºæœ¬ç»„ä»¶æ•°æ®æ¨¡å‹ï¼Œè®©æ‰€æœ‰ç»„ä»¶éƒ½ç»§æ‰¿è¿™ä¸ªæ¨¡å‹ [PanelWidgetModel.ts](https://github.com/Ricbet/panel-magic/blob/master/src/app/panel-extend/panel-widget/model/panel-widget.model.ts)

æ‹¿ button æŒ‰é’®ç»„ä»¶ä¸¾ä¾‹æ¥è¯´ï¼Œå®ƒä½äº `src/app/panel-extend/panel-widget/all-widget-container/button-widget`;

```
â”œâ”€â”€ button-widget.component.html
â”œâ”€â”€ button-widget.component.ts
â””â”€â”€ button-widget.data.ts
```

> å…¶ä¸­ `button-widget.data.ts` æ–‡ä»¶æ˜¯ç”¨äºåœ¨å·¦ä¾§æ‹–æ‹½ç»„ä»¶åˆ°ä¸­é—´ç¼–è¾‘åŒºåŸŸæ—¶å€™çš„é»˜è®¤æ ·å¼å’Œäº‹ä»¶æ•°æ®ï¼Œå®ƒæ˜¯ç›´æ¥å®ä¾‹åŒ–äº† PanelWidgetModel å¹¶å¯¼å‡º

å…¶ä¸­ component ä¸ºï¼›

```Typescript
import { Component, OnInit, Input } from "@angular/core";
import { PanelWidgetModel } from "../../model";

@Component({
    selector: "app-button-widget",
    templateUrl: "./button-widget.component.html",
    styles: [""],
})
export class ButtonWidgetComponent implements OnInit {
    private _widget: PanelWidgetModel;

    @Input()
    public get widget(): PanelWidgetModel {
        return this._widget;
    }
    public set widget(v: PanelWidgetModel) {
        this._widget = v;
    }
    constructor() {}

    ngOnInit() {}
}

```

ç„¶ååœ¨æ¸²æŸ“çš„æ—¶å€™åŒå‘ç»‘å®šé‡Œé¢çš„æ–‡æœ¬æ•°æ®

```html
<p *ngIf="!widget.isHiddenText" class="text-overflow-hidden">{{ widget.autoWidget.content }}</p>
```

å¯¹äºç®€å•çš„ç»„ä»¶ `PanelWidgetModel` æä¾›çš„åŸºæœ¬æ•°æ®æ¨¡å‹è¶³çŸ£ï¼›

ç¨å¾®å¤æ‚çš„ç»„ä»¶å¦‚ `map` åœ°å›¾ç»„ä»¶åˆ™å¯ä»¥åœ¨ component æ–‡ä»¶é‡Œè‡ªè¡Œæ‹“å±• PanelWidgetModel ç±»ï¼›

æœ‰äº† `PanelWidgetModel` ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ¸²æŸ“ç»„ä»¶çš„æ ¸å¿ƒä»£ç éƒ¨åˆ† ğŸ‘‡;

```html
<div class="zoom-area" [ngStyle]="{ 'background-color': panelInfo.bgColor }">
    <ng-container *ngFor="let widget of widgetList$ | async">
        <div class="widget-shell" [ngStyle]="widget.profileModel.styleContent">
            <app-panel-widget [widget]="widget" [isSimpleFunc]="false"></app-panel-widget>
        </div>
    </ng-container>
</div>
```

åœ¨æ¨¡ç‰ˆä¸­å¾ªç¯å¼‚æ­¥æ¸²æŸ“ `widgetList$` é‡Œçš„ç»„ä»¶å¹¶ä¼ é€’æ•°æ®ç»™ app-panel-widget ç»„ä»¶;

å…¶ä¸­ `widgetList$` å®šä¹‰ä¸º;

```typescript
public get widgetList$(): BehaviorSubject<Array<PanelWidgetModel>> {
    return this.panelExtendService.widgetList$;
}

// åœ¨ panelExtendService æœåŠ¡é‡Œ
public widgetList$: BehaviorSubject<Array<PanelWidgetModel>> = new BehaviorSubject<Array<PanelWidgetModel>>([]);
```

å°±æ˜¯ä¸Šè¿°æåˆ°çš„ PanelWidgetModel ç±»åˆ—è¡¨ï¼›

è€Œ app-panel-widget ç»„ä»¶ä½äº `src/app/panel-extend/panel-widget/panel-widget.component.ts`

å®ƒè´Ÿè´£æ¥æ”¶ `widgetList$` é‡Œçš„æ¯ä¸€ä¸ªä¸åŒç»„ä»¶å¹¶æ ¹æ® `type` ç±»å‹è´Ÿè´£æ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ï¼›

```html
<div
    class="widget-main"
    [nrIsStopPropagation]="true"
    nrDraggable
    [nrIdBody]="'#free-panel-main'"
    (launchMouseIncrement)="acceptDraggableIncrement($event)"
    nrMouseMoveOut
    (dblclick)="acceptDoubleClick()"
    (mousedown)="acceptWidgetChecked($event)"
    (emitMouseType)="acceptMouseMoveOut($event)"
    (contextmenu)="acceptWidgetRightClick($event)"
>
    <ng-container *ngIf="widget.autoWidget">
        <div class="widget-content {{ widget.type }}" *ngIf="widget.type != 'combination'" [ngStyle]="widgetStyle">
            <ng-container [ngSwitch]="widget.type">
                <!-- æ–‡æœ¬ -->
                <ng-container *ngSwitchCase="'text'">
                    <app-text-widget [widget]="widget"></app-text-widget>
                </ng-container>
                <!-- å›¾ç‰‡ -->
                <ng-container *ngSwitchCase="'picture'">
                    <app-picture-widget [widget]="widget"></app-picture-widget>
                </ng-container>
                <!-- æŒ‰é’® -->
                <ng-container *ngSwitchCase="'button'">
                    <app-button-widget [widget]="widget"></app-button-widget>
                </ng-container>
                <!-- è¾…åŠ©çº¿ -->
                <ng-container *ngSwitchCase="'line'">
                    <app-auxiliaryline-widget [widget]="widget"></app-auxiliaryline-widget>
                </ng-container>
                <!-- çŸ©å½¢ -->
                <ng-container *ngSwitchCase="'rect'"></ng-container>
                <!-- é“¾æ¥åŒºåŸŸ -->
                <ng-container *ngSwitchCase="'linkrange'">
                    <app-linkrange-widget [widget]="widget"></app-linkrange-widget>
                </ng-container>
                <!-- è½®æ’­å›¾ -->
                <ng-container *ngSwitchCase="'slideshowpicture'">
                    <app-slideshow-picture-view [widget]="widget"></app-slideshow-picture-view>
                </ng-container>
                <!-- å¯Œæ–‡æœ¬ -->
                <ng-container *ngSwitchCase="'richtext'">
                    <app-rich-text-view [autoWidget]="widget"></app-rich-text-view>
                </ng-container>
                <!-- åœ°å›¾ -->
                <ng-container *ngSwitchCase="'map'">
                    <app-map-view [autoWidget]="widget"></app-map-view>
                </ng-container>
                <!-- åŠ¨æ€å®¹å™¨ -->
                <ng-container *ngSwitchCase="'seniorvessel'">
                    <div class="vessel-tip" *ngIf="isViseableVesselTip"><span>åŒå‡»ç¼–è¾‘åŠ¨æ€å®¹å™¨</span></div>
                    <app-senior-vessel-widget [widget]="widget"></app-senior-vessel-widget>
                </ng-container>
            </ng-container>
        </div>
        <!-- ç»„åˆ -->
        <ng-container *ngIf="widget.type == 'combination'">
            <div class="combination-container" [ngStyle]="widgetStyle">
                <ng-container *ngFor="let list of widget.autoWidget.content">
                    <ng-container
                        *ngIf="list.type != 'combination' && (list.profileModel.combinationWidgetData$ | async)"
                    >
                        <div
                            class="widget-shell"
                            [ngStyle]="(list.profileModel.combinationWidgetData$ | async).styleContent"
                        >
                            <app-panel-widget [widget]="list" [isSimpleFunc]="true"></app-panel-widget>
                        </div>
                    </ng-container>
                </ng-container>
            </div>
        </ng-container>
    </ng-container>
</div>
```

æˆ‘ä»¬ç»§ç»­çœ‹ app-panel-widget ç»„ä»¶çš„æ¨¡ç‰ˆéƒ¨åˆ†;

```html
<div
    class="widget-main"
    [nrIsStopPropagation]="true"
    nrDraggable
    [nrIdBody]="'#free-panel-main'"
    (launchMouseIncrement)="acceptDraggableIncrement($event)"
    nrMouseMoveOut
    (dblclick)="acceptDoubleClick()"
    (mousedown)="acceptWidgetChecked($event)"
    (emitMouseType)="acceptMouseMoveOut($event)"
    (contextmenu)="acceptWidgetRightClick($event)"
></div>
```

-   `nrDraggable`: æŒ‡å®šè¯¥ç»„ä»¶æ˜¯å¯æ‹–æ‹½ç»„ä»¶
-   `launchMouseIncrement`: ç”± public é‡Œçš„ DraggableDirective æŒ‡ä»¤æä¾›ï¼Œç”¨äºè¿”å›é¼ æ ‡äº‹ä»¶çš„ movementY å’Œ movementX
-   `nrMouseMoveOut`: ç”± public é‡Œçš„ MousemoveoutDirective æŒ‡ä»¤æä¾›ï¼Œç”¨äºè¿”å›é¼ æ ‡çš„ç§»å…¥å’Œç§»å‡ºäº‹ä»¶ç›‘å¬
-   `emitMouseType`: ç”± public é‡Œçš„ MousemoveoutDirective æŒ‡ä»¤æä¾›ï¼Œè¿”å›é¼ æ ‡æ˜¯ç§»å…¥è¿˜æ˜¯ç§»å‡ºäº‹ä»¶
-   `contextmenu`: å³é”®äº‹ä»¶

æ‰€ä»¥ï¼Œå½“ä½ åœ¨é¢æ¿ä¸­é€‰ä¸­æŸä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œä¸å•å•åªæ˜¯ä¸€ä¸ªç®€å•çš„ click äº‹ä»¶ç»„æˆï¼Œæ˜¯ç”±é¼ æ ‡çš„ç§»å…¥ã€é¼ æ ‡æŒ‰ä¸‹ã€é¼ æ ‡å¼¹èµ·ç­‰åˆ†è§£æ­¥éª¤æ¥å®Œæˆï¼›

æˆ‘ä»¬å…ˆçœ‹çœ‹ `mousedown` äº‹ä»¶, å®ƒæ‰§è¡Œçš„æ–¹æ³•ä¸º `acceptWidgetChecked`ï¼›

```typescript
public acceptWidgetChecked(event: MouseEvent): void {
    if (!this.isSimpleFunc) {
        event.stopPropagation();
        event.preventDefault();
        if (
            !this.panelScopeEnchantmentService.scopeEnchantmentModel.outerSphereInsetWidgetList$.value.some(
                w => w.uniqueId == this.widget.uniqueId
            )
        ) {
            event.shiftKey == true
                ? this.panelScopeEnchantmentService.toggleOuterSphereInsetWidget(this.widget)
                : this.panelScopeEnchantmentService.onlyOuterSphereInsetWidget(this.widget);
        } else {
            if (event.shiftKey == true) this.panelScopeEnchantmentService.toggleOuterSphereInsetWidget(this.widget);
        }
        this.openMouseMoveLaunch();
    }
}
```

è¿™é‡Œå…ˆè¡¥å……ä¸€ä¸‹ï¼Œ[`panelScopeEnchantmentService`](https://github.com/Ricbet/panel-magic/blob/master/src/app/panel-extend/panel-scope-enchantment/panel-scope-enchantment.service.ts) æœåŠ¡è´Ÿè´£ç®¡ç†æ‹–æ‹½æ—¶çš„è¾…åŠ©çº¿è®¡ç®—ã€è½®å»“æè¾¹ç”Ÿæˆä»¥åŠå³é”®äº‹ä»¶ç­‰æ ¸å¿ƒç¼–è¾‘æœåŠ¡ï¼Œè¯¥æœåŠ¡çš„ [`ScopeEnchantmentModel`](https://github.com/Ricbet/panel-magic/blob/master/src/app/panel-extend/panel-scope-enchantment/model/scope-enchantment.model.ts) å°±æ˜¯ç”¨äºç”Ÿæˆç»„ä»¶è½®å»“æ•°æ®å’Œæ‹–æ‹½ç‚¹çš„æ•°æ®æ¨¡å‹ç±»ï¼›

> æ‰€è°“'è½®å»“æè¿°'ï¼Œå°±æ˜¯è®¡ç®—å¤šä¸ªæˆ–å•ä¸ªç»„ä»¶çš„æœ€é•¿ã€æœ€é«˜çš„æè¾¹

å›åˆ° `acceptWidgetChecked`, è¿™é‡Œå½“é¼ æ ‡æŒ‰ä¸‹çš„æ—¶å€™å¹¶ä¸æ˜¯ç›´æ¥ç”Ÿæˆè¯¥ç»„ä»¶çš„è½®å»“æè¿°ï¼Œè€Œæ˜¯å¤šäº† `shiftKey` é”®ç›˜äº‹ä»¶çš„åˆ¤æ–­ï¼Œç”¨äºæŒ‰ä½ `shiftKey` çš„æ—¶å€™å¤šé€‰å¤šä¸ªç»„ä»¶å¹¶å°†ç”Ÿæˆçš„è½®å»“æè¾¹åŒ…å«å‡ºå¤šä¸ªç»„ä»¶ï¼Œå¦‚

![2.gif](../assets/img/17/2.gif)

å…¶ä¸­ç”Ÿæˆè½®å»“çš„é€»è¾‘æ ¸å¿ƒéƒ¨åˆ†åœ¨ `panelScopeEnchantmentService` é‡Œçš„ `handleFromWidgetListToProfileOuterSphere` æ–¹æ³•,ğŸ‘‡

```typescript
public handleFromWidgetListToProfileOuterSphere(arg: { isLaunch?: boolean } = { isLaunch: true }): void {
    const oriArr = this.scopeEnchantmentModel.outerSphereInsetWidgetList$.value.map(e => {
        e.profileModel.isCheck = true;
        // æ ¹æ®å½“å‰ä½ç½®é‡æ–°è®¾ç½®mousecoord
        e.profileModel.setMouseCoord([e.profileModel.left, e.profileModel.top]);
        return e.profileModel;
    });
    if (oriArr.length > 0) {
        // è®¡ç®—å‡ºæœ€å°çš„left,æœ€å°çš„topï¼Œæœ€å¤§çš„widthå’Œheight
        const calcResult = this.calcProfileOuterSphereInfo();
        // å¦‚æœinsetWidgetæ•°é‡å¤§äºä¸€ä¸ªåˆ™ä¸å…è®¸å¼€å¯æ—‹è½¬,ä¸”æ—‹è½¬è§’åº¦é‡ç½®
        if (oriArr.length == 1) {
            calcResult.isRotate = true;
            calcResult.rotate = oriArr[0].rotate;
        } else {
            calcResult.isRotate = false;
        }
        // èµ‹å€¼
        this.scopeEnchantmentModel.launchProfileOuterSphere(calcResult, arg.isLaunch);
        // åŒæ—¶ç”Ÿæˆå…«ä¸ªæ–¹ä½åæ ‡ç‚¹ï¼Œå¦‚æœè¢«é€‰ç»„ä»¶å¤§äºä¸€ä¸ªåˆ™ä¸ç”Ÿæˆ
        this.scopeEnchantmentModel.handleCreateErightCornerPin();
    }
}
```

å…¶ä¸­ `calcProfileOuterSphereInfo` æ˜¯è®¡ç®—å¤§å°å’Œä½ç½®çš„æ ¸å¿ƒ

```typescript
public calcProfileOuterSphereInfo(): OuterSphereHasAuxlModel {
    const insetWidget = this.scopeEnchantmentModel.outerSphereInsetWidgetList$.value;
    let outerSphere = new OuterSphereHasAuxlModel().setData({
        left: Infinity,
        top: Infinity,
        width: -Infinity,
        height: -Infinity,
        rotate: 0,
    });
    let maxWidth = null;
    let maxHeight = null;
    let minWidthEmpty = Infinity;
    let minHeightEmpty = Infinity;
    insetWidget.forEach(e => {
        let offsetCoord = { left: 0, top: 0 };
        if (e.profileModel.rotate != 0 && insetWidget.length > 1) {
            offsetCoord = this.handleOuterSphereRotateOffsetCoord(e.profileModel);
        }

        outerSphere.left = Math.min(outerSphere.left, e.profileModel.left + offsetCoord.left);
        outerSphere.top = Math.min(outerSphere.top, e.profileModel.top + offsetCoord.top);

        maxWidth = Math.max(maxWidth, e.profileModel.left + e.profileModel.width + offsetCoord.left * -1);
        maxHeight = Math.max(maxHeight, e.profileModel.top + e.profileModel.height + offsetCoord.top * -1);

        if (e.profileModel.left + e.profileModel.width < 0) {
            minWidthEmpty = Math.min(minWidthEmpty, Math.abs(e.profileModel.left) - e.profileModel.width);
        } else {
            minWidthEmpty = 0;
        }

        if (e.profileModel.top + e.profileModel.height < 0) {
            minHeightEmpty = Math.min(minHeightEmpty, Math.abs(e.profileModel.top) - e.profileModel.height);
        } else {
            minHeightEmpty = 0;
        }
    });

    outerSphere.width = Math.abs(maxWidth - outerSphere.left) - minWidthEmpty;
    outerSphere.height = Math.abs(maxHeight - outerSphere.top) - minHeightEmpty;
    outerSphere.setMouseCoord([outerSphere.left, outerSphere.top]);

    return outerSphere;
}
```

æ›´ä¸ºå®Œæ•´çš„é€»è¾‘åœ¨ `panelScopeEnchantmentService` æœåŠ¡é‡Œï¼›

æ¥ä¸‹æ¥å°±æ˜¯æ‹–æ‹½äº‹ä»¶ï¼Œæ‹–æ‹½çš„ç»„ä»¶å¹¶ä¸å•å•æ˜¯æŸä¸ªç»„ä»¶ï¼Œè€Œæ˜¯è½®å»“åŒ…å«åœ¨å†…çš„æ‰€æœ‰è¢«é€‰ä¸­ç»„ä»¶ï¼Œæ ¸å¿ƒä»£ç åœ¨ `src/app/panel-extend/panel-scope-enchantment/model/scope-enchantment.model.ts` çš„ `handleLocationInsetWidget` æ–¹æ³•é‡Œï¼›

```typescript
/**
 * æ ¹æ®ä¸»è½®å»“çš„ä½ç½®è®¡ç®—è½®å»“å†…è¢«é€‰ç»„ä»¶çš„ä½ç½®
 */
public handleLocationInsetWidget(
    increment: DraggablePort,
    allWidget: Array<PanelWidgetModel> = this.outerSphereInsetWidgetList$.value
): void {
    if (Array.isArray(allWidget)) {
        const pro = this.valueProfileOuterSphere;
        // æ‰€æœ‰è½®å»“å†…çš„ç»„ä»¶è®¡ç®—ä½ç½®
        allWidget.forEach(w => {
            w.profileModel.mouseCoord[0] += increment.left;
            w.profileModel.mouseCoord[1] += increment.top;
            let obj = { left: w.profileModel.mouseCoord[0], top: w.profileModel.mouseCoord[1] };
            if (!(pro.lLine || pro.rLine || pro.vcLine)) {
                obj.left = w.profileModel.mouseCoord[0];
                pro.left = pro.mouseCoord[0];
            } else {
                obj.left += pro.left - pro.mouseCoord[0];
            }
            if (!(pro.tLine || pro.bLine || pro.hcLine)) {
                obj.top = w.profileModel.mouseCoord[1];
                pro.top = pro.mouseCoord[1];
            } else {
                obj.top += pro.top - pro.mouseCoord[1];
            }
            w.profileModel.setData(obj);
            /**
             * å¦‚æœè¢«é€‰çš„æ‰€æœ‰ç»„ä»¶å½“ä¸­æœ‰ç»„åˆç»„ä»¶combinationï¼Œåˆ™éœ€è¦é‡æ–°è®¡ç®—å…¶å­é›†çš„æ‰€æœ‰widgetè½®å»“æ•°å€¼
             */
            if (w.type == "combination") {
                this.handleLocationInsetWidget(increment, w.autoWidget.content);
            }
        });
    }
}
```

æ³¨ï¼šç”±äºæ‹–æ‹½çš„è¿‡ç¨‹å½“ä¸­ï¼Œæ”¹å˜çš„æ˜¯æ¯ä¸ªç»„ä»¶è‡ªèº«çš„ä½ç½®ä¿¡æ¯æ•°æ®ï¼Œè€Œè½®å»“æè¿°æ˜¯ç”± `calcProfileOuterSphereInfo` è®¡ç®—ç”Ÿæˆçš„ï¼Œæ‰€æœ‰åœ¨æ‹–æ‹½çš„è¿‡ç¨‹å½“ä¸­è¿˜éœ€è¦å®æ—¶è®¡ç®—ä¸»è½®å»“æè¿°çš„æ•°æ®ï¼›

å°ç»“ï¼šç»„ä»¶çš„å¸ƒå±€æ’ç‰ˆä¾èµ–äº `PanelWidgetModel` æ•°æ®æ¨¡å‹ç±», å•é€‰å’Œå¤šé€‰å¹¶ä¸€èµ·æ‹–æ‹½ä¾èµ–äº `ScopeEnchantmentModel` æ•°æ®æ¨¡å‹ç±»ï¼Œè¿˜æœ‰å…¶ä»–çš„ç»†èŠ‚å®ç°è¿™é‡Œå°±ä¸ä¸€ä¸€é˜è¿°

## å¯¹é½è¾…åŠ©çº¿ç”Ÿæˆè§„åˆ™ ##

å…ˆçœ‹çœ‹å¯¹é½è¾…åŠ©çº¿æ•ˆæœ;

![3.gif](../assets/img/17/3.gif)

ç”¨è¿‡ PS çš„è›‡é¸¡ä¸åº”è¯¥å¯¹è¿™ä¸ªåŠŸèƒ½ä¸ä¼šé™Œç”Ÿï¼Œæˆ‘ä¸ªäººä¹Ÿå¾ˆå–œæ¬¢è¿™ä¹ˆç‰›é€¼çš„è¾…åŠ©çº¿å¯¹é½ï¼›

æˆ‘ä»¬å…ˆçœ‹çœ‹å¯¹é½è¾…åŠ©çº¿æ¸²æŸ“çš„æ¨¡ç‰ˆæ–‡ä»¶ï¼Œå®ƒä½äº `src/app/panel-extend/panel-scope-enchantment/panel-scope-enchantment.component.html`ï¼›

```html
<!-- è¾…åŠ©çº¿ -->
<div class="auxiliary-container">
    <ng-container *ngIf="scopeEnchantment.profileOuterSphere$ | async">
        <div
            class="v v-left"
            *ngIf="(scopeEnchantment.profileOuterSphere$ | async).lLine"
            [ngStyle]="{
                left:
                    (scopeEnchantment.profileOuterSphere$ | async).left +
                    (scopeEnchantment.profileOuterSphere$ | async).offsetAmount.left +
                    'px'
            }"
        ></div>
        <div
            class="v v-center"
            *ngIf="(scopeEnchantment.profileOuterSphere$ | async).vcLine"
            [ngStyle]="{ left: (scopeEnchantment.profileOuterSphere$ | async).vCenterStyle + 'px' }"
        ></div>
        <div
            class="v v-right"
            *ngIf="(scopeEnchantment.profileOuterSphere$ | async).rLine"
            [ngStyle]="{
                left:
                    (scopeEnchantment.profileOuterSphere$ | async).rightStyle -
                    (scopeEnchantment.profileOuterSphere$ | async).offsetAmount.left +
                    'px'
            }"
        ></div>
        <div
            class="h h-top"
            *ngIf="(scopeEnchantment.profileOuterSphere$ | async).tLine"
            [ngStyle]="{
                top:
                    (scopeEnchantment.profileOuterSphere$ | async).top +
                    (scopeEnchantment.profileOuterSphere$ | async).offsetAmount.top +
                    'px'
            }"
        ></div>
        <div
            class="h h-center"
            *ngIf="(scopeEnchantment.profileOuterSphere$ | async).hcLine"
            [ngStyle]="{ top: (scopeEnchantment.profileOuterSphere$ | async).hCenterStyle + 'px' }"
        ></div>
        <div
            class="h h-bottom"
            *ngIf="(scopeEnchantment.profileOuterSphere$ | async).bLine"
            [ngStyle]="{
                top:
                    (scopeEnchantment.profileOuterSphere$ | async).bottomStyle -
                    (scopeEnchantment.profileOuterSphere$ | async).offsetAmount.top +
                    'px'
            }"
        ></div>
    </ng-container>
</div>
```

> ps: è¾…åŠ©çº¿çš„è®¡ç®—ç”Ÿæˆè§„åˆ™ä¼šé‡åˆ°æ—‹è½¬è§’åº¦å˜åŒ–çš„å½±å“ï¼Œè§£å†³è¿™ä¸ªå½±å“å¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡æ°´æ–‡ [12.æ‹–æ‹½æ‹‰ä¼¸åŠ ä¸Šæ—‹è½¬è§’åº¦çš„æ•°å­¦åŸç†](https://github.com/Ricbet/blog/blob/master/src/article/12.%E6%8B%96%E6%8B%BD%E6%8B%89%E4%BC%B8%E5%8A%A0%E4%B8%8A%E6%97%8B%E8%BD%AC%E8%A7%92%E5%BA%A6%E7%9A%84%E6%95%B0%E5%AD%A6%E5%8E%9F%E7%90%86.md)

å¯è§è¾…åŠ©çº¿ä¾èµ–äº `ScopeEnchantmentModel` é‡Œçš„ `profileOuterSphere$`, å®šä¹‰å¦‚ä¸‹;

```typescript
public profileOuterSphere$: BehaviorSubject<OuterSphereHasAuxlModel> = new BehaviorSubject(null);
```


## ç»„åˆç»„ä»¶å’Œæ—‹è½¬æ‹‰ä¼¸ ##

## å‰è¿›å’Œåé€€ ##

## å‰ªè´´è’™ç‰ˆ ##

## åŠ¨æ€å®¹å™¨ ##

## å…³äºå¦‚ä½•ç”Ÿæˆå°ç¨‹åº ##
